<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
        <%= title || 'Gestión Documental' %>
    </title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

    <!-- CSS Personalizado -->
    <style>
        :root {
            --primary-custom: #0d6efd;
            --secondary-custom: #6c757d;
            --success-custom: #198754;
            --warning-custom: #ffc107;
            --danger-custom: #dc3545;
        }

        .bg-primary-custom {
            background-color: var(--primary-custom) !important;
        }

        .btn-primary-custom {
            background-color: var(--primary-custom);
            border-color: var(--primary-custom);
            color: white;
        }

        .btn-primary-custom:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }

        .document-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
            cursor: pointer;
        }

        .document-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .badge-vigente {
            background-color: var(--success-custom);
            color: white;
        }

        .badge-por-vencer {
            background-color: var(--warning-custom);
            color: #000;
        }

        .badge-vencido {
            background-color: var(--danger-custom);
            color: white;
        }

        .action-buttons .btn {
            margin: 2px;
            min-width: 40px;
        }

        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }

        /* Estilos para los contadores */
        .counter-card {
            border-radius: 12px;
            padding: 20px;
            color: white;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .counter-card:hover {
            transform: translateY(-5px);
        }

        .counter-total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .counter-vigente {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
        }

        .counter-por-vencer {
            background: linear-gradient(135deg, #FF9800 0%, #FFC107 100%);
            color: #000;
        }

        .counter-vencido {
            background: linear-gradient(135deg, #F44336 0%, #E91E63 100%);
        }

        .counter-card h3 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .counter-card p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0;
        }

        .card-header-custom {
            background: linear-gradient(135deg, var(--primary-custom) 0%, #0b5ed7 100%);
            color: white;
            border-bottom: none;
        }

        .alert-urgente {
            border-left: 5px solid var(--danger-custom);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }

            100% {
                opacity: 1;
            }
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-vigente {
            background-color: var(--success-custom);
        }

        .status-por-vencer {
            background-color: var(--warning-custom);
        }

        .status-vencido {
            background-color: var(--danger-custom);
        }

        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: var(--primary-custom);
            background-color: #e9f7fe;
        }

        .file-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary-custom shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="bi bi-car-front-fill me-2"></i>Gestión Vehicular
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarVehicular">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarVehicular">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Inicio</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownPersonas" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-people me-1"></i>Personas
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdownPersonas">
                            <li><a class="dropdown-item" href="/personas/agregar">
                                    <i class="bi bi-person-plus me-2"></i>Agregar Persona
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="/personas">
                                    <i class="bi bi-list-ul me-2"></i>Listar Personas
                                </a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownVehiculos" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-truck me-1"></i>Vehículos
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdownVehiculos">
                            <li><a class="dropdown-item" href="/vehiculos/agregar">
                                    <i class="bi bi-plus-circle me-2"></i>Agregar Vehículo
                                </a></li>
                            <li><a class="dropdown-item" href="/vehiculos">
                                    <i class="bi bi-list-ul me-2"></i>Listar Vehículos
                                </a></li>
                        </ul>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link active" href="/documentos">
                            <i class="bi bi-file-earmark-text me-1"></i>Documentos
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="/reportes">
                            <i class="bi bi-graph-up me-1"></i>Reportes
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="/login">
                            <i class="bi bi-box-arrow-in-right me-1"></i>Login
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mt-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="text-primary-custom mb-2">
                    <i class="bi bi-file-earmark-text me-2"></i>Gestión Documental
                </h1>
                <p class="text-muted">
                    Sistema de control y seguimiento de documentos vehiculares
                </p>
            </div>
            <div>
                <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#modalNuevoDocumento">
                    <i class="bi bi-plus-circle me-1"></i>Nuevo Documento
                </button>
            </div>
        </div>

        <!-- Mensajes Flash -->
        <% if (success_msg && success_msg.length> 0) { %>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle me-2"></i>
                <%= success_msg %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            <% } %>

                <% if (error_msg && error_msg.length> 0) { %>
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <%= error_msg %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    <% } %>

                        <!-- Contadores de Estado -->
                        <div class="row mb-5">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="counter-card counter-total">
                                    <i class="bi bi-files" style="font-size: 2.5rem; margin-bottom: 15px;"></i>
                                    <h3 id="totalDocumentos">
                                        <%= totalDocumentos || 0 %>
                                    </h3>
                                    <p class="mb-0">TOTAL DOCUMENTOS</p>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="counter-card counter-vigente">
                                    <i class="bi bi-check-circle" style="font-size: 2.5rem; margin-bottom: 15px;"></i>
                                    <h3 id="documentosVigentes">
                                        <%= documentosVigentes || 0 %>
                                    </h3>
                                    <p class="mb-0">VIGENTES</p>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="counter-card counter-por-vencer">
                                    <i class="bi bi-exclamation-triangle"
                                        style="font-size: 2.5rem; margin-bottom: 15px;"></i>
                                    <h3 id="documentosPorVencer">
                                        <%= documentosPorVencer || 0 %>
                                    </h3>
                                    <p class="mb-0">POR VENCER</p>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="counter-card counter-vencido">
                                    <i class="bi bi-x-circle" style="font-size: 2.5rem; margin-bottom: 15px;"></i>
                                    <h3 id="documentosVencidos">
                                        <%= documentosVencidos || 0 %>
                                    </h3>
                                    <p class="mb-0">VENCIDOS</p>
                                </div>
                            </div>
                        </div>

                        <!-- Documentos Próximos a Vencer (Urgentes) -->
                        <% if (documentosProximos && documentosProximos.length> 0) { %>
                            <div class="card shadow-sm mb-5">
                                <div class="card-header card-header-custom">
                                    <h5 class="mb-0">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        Documentos Próximos a Vencer (Próximos 30 días)
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm">
                                            <thead class="table-light">
                                                <tr>
                                                    <th><i class="bi bi-tag"></i> Tipo</th>
                                                    <th><i class="bi bi-truck"></i> Vehículo</th>
                                                    <th><i class="bi bi-hash"></i> Número</th>
                                                    <th><i class="bi bi-calendar-event"></i> Vencimiento</th>
                                                    <th><i class="bi bi-clock"></i> Días Restantes</th>
                                                    <th><i class="bi bi-circle-fill"></i> Estado</th>
                                                    <th><i class="bi bi-gear"></i> Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% documentosProximos.forEach(doc=> {
                                                    const hoy = new Date();
                                                    const vencimiento = new Date(doc.fecha_vencimiento);
                                                    const diffTime = vencimiento - hoy;
                                                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                                                    let estadoClase = '';
                                                    let estadoTexto = '';

                                                    if (diffDays <= 0) { estadoClase='badge-vencido' ;
                                                        estadoTexto='Vencido' ; } else if (diffDays <=7) {
                                                        estadoClase='badge-vencido alert-urgente' ;
                                                        estadoTexto='Urgente' ; } else if (diffDays <=30) {
                                                        estadoClase='badge-por-vencer' ; estadoTexto='Por vencer' ; }
                                                        else { estadoClase='badge-vigente' ; estadoTexto='Vigente' ; }
                                                        %>
                                                        <tr class="<%= diffDays <= 7 ? 'table-warning' : '' %>">
                                                            <td>
                                                                <span class="badge bg-info text-dark">
                                                                    <%= doc.tipo_documento || 'Sin tipo' %>
                                                                </span>
                                                            </td>
                                                            <td>
                                                                <div class="fw-bold">
                                                                    <%= doc.placa || 'Sin placa' %>
                                                                </div>
                                                                <small class="text-muted">
                                                                    <%= doc.marca || '' %>
                                                                        <%= doc.modelo || '' %>
                                                                </small>
                                                            </td>
                                                            <td>
                                                                <code><%= doc.numero_documento || 'N/A' %></code>
                                                            </td>
                                                            <td>
                                                                <div class="fw-semibold">
                                                                    <%= vencimiento.toLocaleDateString('es-ES', {
                                                                        weekday: 'short' , year: 'numeric' ,
                                                                        month: 'short' , day: 'numeric' }) %>
                                                                </div>
                                                                <small class="text-muted">
                                                                    Emisión: <%= doc.fecha_emision ? new
                                                                        Date(doc.fecha_emision).toLocaleDateString()
                                                                        : 'N/A' %>
                                                                </small>
                                                            </td>
                                                            <td>
                                                                <% if (diffDays <=0) { %>
                                                                    <span class="badge bg-danger">
                                                                        <i class="bi bi-clock-history"></i> Vencido
                                                                    </span>
                                                                    <% } else { %>
                                                                        <span
                                                                            class="badge <%= diffDays <= 7 ? 'bg-danger' : diffDays <= 30 ? 'bg-warning text-dark' : 'bg-success' %>">
                                                                            <%= diffDays %> días
                                                                        </span>
                                                                        <% } %>
                                                            </td>
                                                            <td>
                                                                <span class="badge <%= estadoClase %>">
                                                                    <span
                                                                        class="status-indicator status-<%= doc.estado || 'vigente' %>"></span>
                                                                    <%= estadoTexto %>
                                                                </span>
                                                            </td>
                                                            <td class="action-buttons">
                                                                <button class="btn btn-sm btn-outline-primary"
                                                                    onclick="verDetalleDocumento('<%= doc.id_documento_veh %>')"
                                                                    title="Ver detalle">
                                                                    <i class="bi bi-eye"></i>
                                                                </button>
                                                                <% if (doc.ruta_archivo) { %>
                                                                    <a href="<%= doc.ruta_archivo %>"
                                                                        class="btn btn-sm btn-outline-success"
                                                                        target="_blank" title="Descargar archivo">
                                                                        <i class="bi bi-download"></i>
                                                                    </a>
                                                                    <% } %>
                                                                        <button class="btn btn-sm btn-outline-warning"
                                                                            onclick="enviarRecordatorio('<%= doc.id_documento_veh %>')"
                                                                            title="Enviar recordatorio">
                                                                            <i class="bi bi-envelope"></i>
                                                                        </button>
                                                            </td>
                                                        </tr>
                                                        <% }); %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <% } %>

                                <!-- Documentos Recientes -->
                                <div class="row">
                                    <div class="col-lg-8">
                                        <div class="card shadow-sm">
                                            <div class="card-header bg-light">
                                                <h5 class="mb-0">
                                                    <i class="bi bi-clock-history me-2"></i>Documentos Recientes
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <% if (documentos && documentos.length> 0) { %>
                                                    <div class="table-responsive">
                                                        <table id="tablaDocumentos" class="table table-hover">
                                                            <thead>
                                                                <tr>
                                                                    <th>Tipo</th>
                                                                    <th>Vehículo</th>
                                                                    <th>Número</th>
                                                                    <th>Vencimiento</th>
                                                                    <th>Estado</th>
                                                                    <th>Acciones</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <% documentos.forEach(doc=> {
                                                                    const fechaVenc = doc.fecha_vencimiento ? new
                                                                    Date(doc.fecha_vencimiento) : new Date();
                                                                    const hoy = new Date();
                                                                    const diasRestantes = Math.ceil((fechaVenc - hoy) /
                                                                    (1000 * 60 * 60 * 24));
                                                                    %>
                                                                    <tr>
                                                                        <td>
                                                                            <div class="d-flex align-items-center">
                                                                                <i
                                                                                    class="bi bi-file-earmark-text me-2 text-primary"></i>
                                                                                <span>
                                                                                    <%= doc.tipo_documento || 'Sin tipo'
                                                                                        %>
                                                                                </span>
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <div class="fw-bold">
                                                                                <%= doc.placa || 'Sin asignar' %>
                                                                            </div>
                                                                            <small class="text-muted">
                                                                                <%= doc.marca || '' %>
                                                                                    <%= doc.modelo || '' %>
                                                                            </small>
                                                                        </td>
                                                                        <td>
                                                                            <%= doc.numero_documento || 'N/A' %>
                                                                        </td>
                                                                        <td>
                                                                            <%= fechaVenc.toLocaleDateString() %>
                                                                                <br>
                                                                                <small class="text-muted">
                                                                                    <%= diasRestantes> 0 ?
                                                                                        `${diasRestantes} días` :
                                                                                        'Vencido' %>
                                                                                </small>
                                                                        </td>
                                                                        <td>
                                                                            <span
                                                                                class="badge badge-<%= doc.estado || 'vigente' %>">
                                                                                <%= (doc.estado || 'vigente'
                                                                                    ).replace('_', ' ' ) %>
                                                                            </span>
                                                                        </td>
                                                                        <td>
                                                                            <div class="btn-group btn-group-sm">
                                                                                <button class="btn btn-outline-primary"
                                                                                    onclick="verDetalleDocumento('<%= doc.id_documento_veh %>')">
                                                                                    <i class="bi bi-eye"></i>
                                                                                </button>
                                                                                <button class="btn btn-outline-warning"
                                                                                    onclick="editarDocumento('<%= doc.id_documento_veh %>')">
                                                                                    <i class="bi bi-pencil"></i>
                                                                                </button>
                                                                                <% if (doc.ruta_archivo) { %>
                                                                                    <a href="<%= doc.ruta_archivo %>"
                                                                                        class="btn btn-outline-success"
                                                                                        target="_blank">
                                                                                        <i class="bi bi-download"></i>
                                                                                    </a>
                                                                                    <% } %>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                    <% }); %>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <% } else { %>
                                                        <div class="text-center py-5">
                                                            <i class="bi bi-file-earmark-text text-muted"
                                                                style="font-size: 4rem;"></i>
                                                            <h4 class="mt-3 text-muted">No hay documentos registrados
                                                            </h4>
                                                            <p class="text-muted">Comienza agregando tu primer documento
                                                            </p>
                                                            <button class="btn btn-primary-custom"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#modalNuevoDocumento">
                                                                <i class="bi bi-plus-circle me-1"></i>Agregar Primer
                                                                Documento
                                                            </button>
                                                        </div>
                                                        <% } %>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Panel lateral - Acciones rápidas -->
                                    <div class="col-lg-4">
                                        <div class="card shadow-sm mb-4">
                                            <div class="card-header bg-light">
                                                <h5 class="mb-0">
                                                    <i class="bi bi-lightning-charge me-2"></i>Acciones Rápidas
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="d-grid gap-2">
                                                    <button class="btn btn-primary-custom" data-bs-toggle="modal"
                                                        data-bs-target="#modalNuevoDocumento">
                                                        <i class="bi bi-plus-circle me-2"></i>Nuevo Documento
                                                    </button>
                                                    <a href="/documentos/vehiculos" class="btn btn-outline-primary">
                                                        <i class="bi bi-list-ul me-2"></i>Ver Todos los Documentos
                                                    </a>
                                                    <button class="btn btn-outline-success" data-bs-toggle="modal"
                                                        data-bs-target="#modalGenerarReporte">
                                                        <i class="bi bi-file-earmark-pdf me-2"></i>Generar Reporte PDF
                                                    </button>
                                                    <button class="btn btn-outline-info" data-bs-toggle="modal"
                                                        data-bs-target="#modalNuevoTipo">
                                                        <i class="bi bi-plus-square me-2"></i>Agregar Tipo de Documento
                                                    </button>
                                                    <button class="btn btn-outline-warning"
                                                        onclick="actualizarEstados()">
                                                        <i class="bi bi-arrow-clockwise me-2"></i>Actualizar Estados
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Estadísticas -->
                                        <div class="card shadow-sm">
                                            <div class="card-header bg-light">
                                                <h5 class="mb-0">
                                                    <i class="bi bi-bar-chart me-2"></i>Estadísticas
                                                </h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <small class="text-muted">Fecha del servidor:</small>
                                                    <div class="fw-bold">
                                                        <i class="bi bi-calendar-check me-1"></i>
                                                        <%= new Date(fecha).toLocaleString('es-ES', { weekday: 'long' ,
                                                            year: 'numeric' , month: 'long' , day: 'numeric' ,
                                                            hour: '2-digit' , minute: '2-digit' }) %>
                                                    </div>
                                                </div>
                                                <hr>
                                                <% // Calcular todos los porcentajes primero let porVencerPct=0; let
                                                    vencidosPct=0; let vigentesPct=0; if (totalDocumentos &&
                                                    totalDocumentos> 0) {
                                                    porVencerPct = Math.min((documentosPorVencer / totalDocumentos *
                                                    100), 100);
                                                    vencidosPct = Math.min((documentosVencidos / totalDocumentos * 100),
                                                    100);
                                                    vigentesPct = Math.min((documentosVigentes / totalDocumentos * 100),
                                                    100);
                                                    }
                                                    %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
    </main>

    <!-- Modales -->

    <!-- Modal Nuevo Documento -->
    <div class="modal fade" id="modalNuevoDocumento" tabindex="-1" aria-labelledby="modalNuevoDocumentoLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary-custom text-white">
                    <h5 class="modal-title" id="modalNuevoDocumentoLabel">
                        <i class="bi bi-plus-circle me-2"></i>Nuevo Documento Vehicular
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <form id="formNuevoDocumento" action="/documentos/vehiculo/registrar" method="POST"
                    enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_vehiculo" class="form-label">Vehículo <span
                                        class="text-danger">*</span></label>
                                <select class="form-select" id="id_vehiculo" name="id_vehiculo" required>
                                    <option value="">Seleccionar vehículo...</option>
                                    <% if (vehiculos && vehiculos.length> 0) { %>
                                        <% vehiculos.forEach(vehiculo=> { %>
                                            <option value="<%= vehiculo.id_vehiculo %>">
                                                <%= vehiculo.placa %> - <%= vehiculo.marca %>
                                                        <%= vehiculo.modelo %>
                                            </option>
                                            <% }); %>
                                                <% } else { %>
                                                    <option value="" disabled>No hay vehículos disponibles</option>
                                                    <% } %>
                                </select>
                                <div class="form-text">Seleccione el vehículo al que pertenece el documento</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="id_tipo_documento_veh" class="form-label">Tipo de Documento <span
                                        class="text-danger">*</span></label>
                                <select class="form-select" id="id_tipo_documento_veh" name="id_tipo_documento_veh"
                                    required>
                                    <option value="">Seleccionar tipo...</option>
                                    <% if (tiposDocumentos && tiposDocumentos.length> 0) { %>
                                        <% tiposDocumentos.forEach(tipo=> { %>
                                            <option value="<%= tipo.id_tipo_documento_veh %>">
                                                <%= tipo.nombre %>
                                                    <% if (tipo.descripcion) { %> - <%= tipo.descripcion %>
                                                            <% } %>
                                            </option>
                                            <% }); %>
                                                <% } else { %>
                                                    <option value="1">SOAT</option>
                                                    <option value="2">Revisión Técnica</option>
                                                    <option value="3">Seguro Contractual</option>
                                                    <option value="4">Seguro Extracontractual</option>
                                                    <option value="5">Tarjeta de Operación</option>
                                                    <option value="6">Licencia de Tránsito</option>
                                                    <option value="7">Otros</option>
                                                    <% } %>
                                </select>
                                <div class="form-text">Tipo de documento según catálogo</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="numero_documento" class="form-label">Número de Documento <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="numero_documento" name="numero_documento"
                                    placeholder="Ej: SOAT-001-2024" required>
                                <div class="form-text">Número único del documento</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="fecha_emision" class="form-label">Fecha de Emisión</label>
                                <input type="date" class="form-control" id="fecha_emision" name="fecha_emision">
                                <div class="form-text">Fecha en que se emitió el documento</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fecha_vencimiento" class="form-label">Fecha de Vencimiento <span
                                        class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="fecha_vencimiento" name="fecha_vencimiento"
                                    required>
                                <div class="form-text">Fecha límite de validez del documento</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="dias_alerta" class="form-label">Días para Alerta</label>
                                <input type="number" class="form-control" id="dias_alerta" name="dias_alerta" value="30"
                                    min="1" max="365">
                                <div class="form-text">Días antes del vencimiento para enviar alerta</div>
                            </div>
                        </div>

                        <!-- Área de subida de archivo -->
                        <div class="mb-3">
                            <label class="form-label">Archivo Digital (Opcional)</label>
                            <div class="upload-area" id="uploadArea"
                                onclick="document.getElementById('archivo_documento').click()">
                                <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #6c757d;"></i>
                                <p class="mt-2">Haz clic o arrastra un archivo aquí</p>
                                <small class="text-muted">Formatos aceptados: PDF, JPG, PNG (Máx. 10MB)</small>
                                <div id="filePreview" class="mt-3"></div>
                            </div>
                            <input type="file" class="form-control d-none" id="archivo_documento"
                                name="archivo_documento" accept=".pdf,.jpg,.jpeg,.png" onchange="previewFile(this)">
                        </div>

                        <div class="mb-3">
                            <label for="observaciones" class="form-label">Observaciones</label>
                            <textarea class="form-control" id="observaciones" name="observaciones" rows="3"
                                placeholder="Notas adicionales sobre el documento..."></textarea>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="enviar_alerta" name="enviar_alerta"
                                checked>
                            <label class="form-check-label" for="enviar_alerta">
                                Enviar alerta por correo cuando el documento esté próximo a vencer
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary-custom">Guardar Documento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Tipo de Documento -->
    <div class="modal fade" id="modalNuevoTipo" tabindex="-1" aria-labelledby="modalNuevoTipoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="modalNuevoTipoLabel">
                        <i class="bi bi-plus-square me-2"></i>Nuevo Tipo de Documento
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <form action="/documentos/tipos/nuevo" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="nombreTipo" class="form-label">Nombre del Tipo <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="nombreTipo" name="nombre"
                                placeholder="Ej: Póliza de Seguro" required>
                        </div>
                        <div class="mb-3">
                            <label for="descripcionTipo" class="form-label">Descripción</label>
                            <textarea class="form-control" id="descripcionTipo" name="descripcion" rows="2"
                                placeholder="Descripción del tipo de documento..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="diasAlertaTipo" class="form-label">Días para Alerta Predeterminados</label>
                            <input type="number" class="form-control" id="diasAlertaTipo" name="dias_alerta" value="30"
                                min="1" max="365">
                            <div class="form-text">Días antes del vencimiento para enviar alerta automática</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-info text-white">Guardar Tipo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Generar Reporte -->
    <div class="modal fade" id="modalGenerarReporte" tabindex="-1" aria-labelledby="modalGenerarReporteLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalGenerarReporteLabel">
                        <i class="bi bi-file-earmark-pdf me-2"></i>Generar Reporte PDF
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tipo de Reporte</label>
                        <select class="form-select" id="tipoReporte">
                            <option value="todos">Todos los documentos</option>
                            <option value="vigentes">Documentos vigentes</option>
                            <option value="por_vencer">Documentos por vencer</option>
                            <option value="vencidos">Documentos vencidos</option>
                            <option value="mes_actual">Vencen este mes</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Formato</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="formatoReporte" id="formatoPDF"
                                value="pdf" checked>
                            <label class="form-check-label" for="formatoPDF">
                                <i class="bi bi-file-earmark-pdf text-danger"></i> PDF
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="formatoReporte" id="formatoExcel"
                                value="excel">
                            <label class="form-check-label" for="formatoExcel">
                                <i class="bi bi-file-earmark-excel text-success"></i> Excel
                            </label>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        El reporte se generará con los datos actuales del sistema y podrá descargarse automáticamente.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="generarReporte()">
                        <i class="bi bi-download me-1"></i>Generar Reporte
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-primary-custom text-center text-white mt-5 py-4">
        <div class="container">
            <p class="mb-1">
                &copy; <%= new Date().getFullYear() %> Sistema de Gestión Vehicular
            </p>
            <p class="small mb-0">
                <i class="bi bi-calendar-check me-1"></i>Fecha del servidor:
                <span id="fechaServidor">
                    <%= new Date(fecha).toLocaleString() %>
                </span>
            </p>
            <small>
                <i class="bi bi-shield-check me-1"></i>Control • Seguridad • Reportes Automatizados
            </small>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script>
        $(document).ready(function () {
            // Inicializar DataTable
            if ($('#tablaDocumentos').length) {
                $('#tablaDocumentos').DataTable({
                    language: {
                        url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
                    },
                    order: [[3, 'asc']], // Ordenar por fecha de vencimiento
                    pageLength: 10,
                    responsive: true
                });
            }

            // Configurar fecha mínima para vencimiento
            const hoy = new Date().toISOString().split('T')[0];
            $('#fecha_vencimiento').attr('min', hoy);

            // Configurar fecha máxima para emisión
            $('#fecha_emision').attr('max', hoy);
        });

        // Función para previsualizar archivo
        function previewFile(input) {
            const preview = document.getElementById('filePreview');
            const uploadArea = document.getElementById('uploadArea');

            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();

                reader.onload = function (e) {
                    preview.innerHTML = '';

                    if (file.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'file-preview';
                        preview.appendChild(img);
                    } else if (file.type === 'application/pdf') {
                        const icon = document.createElement('i');
                        icon.className = 'bi bi-file-earmark-pdf text-danger';
                        icon.style.fontSize = '4rem';
                        preview.appendChild(icon);
                    }

                    const fileName = document.createElement('p');
                    fileName.className = 'mt-2 mb-0';
                    fileName.textContent = file.name;
                    preview.appendChild(fileName);

                    uploadArea.style.borderColor = '#198754';
                    uploadArea.style.backgroundColor = '#e8f5e9';
                };

                reader.readAsDataURL(file);
            }
        }

        // Función para ver detalle de documento
        function verDetalleDocumento(idDocumento) {
            window.location.href = `/documentos/detalle/${idDocumento}`;
        }

        // Función para editar documento
        function editarDocumento(idDocumento) {
            window.location.href = `/documentos/editar/${idDocumento}`;
        }

        // Función para enviar recordatorio
        function enviarRecordatorio(idDocumento) {
            if (confirm('¿Enviar recordatorio por correo electrónico?')) {
                fetch(`/documentos/recordatorio/${idDocumento}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message || 'Recordatorio enviado correctamente');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al enviar el recordatorio');
                    });
            }
        }

        // Función para actualizar estados
        function actualizarEstados() {
            if (confirm('¿Actualizar estados de documentos automáticamente?')) {
                fetch('/documentos/actualizar-estados')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Estados actualizados correctamente');
                            location.reload();
                        } else {
                            alert('Error al actualizar estados');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al actualizar estados');
                    });
            }
        }

        // Función para generar reporte
        function generarReporte() {
            const tipo = $('#tipoReporte').val();
            const formato = $('input[name="formatoReporte"]:checked').val();

            alert(`Generando reporte ${tipo} en formato ${formato.toUpperCase()}...`);

            // En una implementación real, esto haría una petición al servidor
            // Por ahora simulamos la generación
            setTimeout(() => {
                alert('Reporte generado. Comenzando descarga...');
                // Redirigir a la ruta de generación de reporte
                window.location.href = `/documentos/reporte?tipo=${tipo}&formato=${formato}`;
            }, 1000);
        }

        // Validación del formulario
        document.getElementById('formNuevoDocumento').addEventListener('submit', function (e) {
            const fechaVencimiento = document.getElementById('fecha_vencimiento').value;
            const fechaEmision = document.getElementById('fecha_emision').value;

            if (fechaEmision && fechaVencimiento && fechaVencimiento < fechaEmision) {
                e.preventDefault();
                alert('La fecha de vencimiento no puede ser anterior a la fecha de emisión');
                return false;
            }

            if (!fechaVencimiento) {
                e.preventDefault();
                alert('La fecha de vencimiento es obligatoria');
                return false;
            }

            // Validar archivo si se seleccionó
            const archivoInput = document.getElementById('archivo_documento');
            if (archivoInput.files.length > 0) {
                const archivo = archivoInput.files[0];
                const maxSize = 10 * 1024 * 1024; // 10MB

                if (archivo.size > maxSize) {
                    e.preventDefault();
                    alert('El archivo es demasiado grande. Tamaño máximo: 10MB');
                    return false;
                }

                const extensionesPermitidas = ['.pdf', '.jpg', '.jpeg', '.png'];
                const extension = archivo.name.substring(archivo.name.lastIndexOf('.')).toLowerCase();

                if (!extensionesPermitidas.includes(extension)) {
                    e.preventDefault();
                    alert('Formato de archivo no permitido. Use PDF, JPG o PNG');
                    return false;
                }
            }

            // Mostrar mensaje de procesamiento
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
            submitBtn.disabled = true;

            return true;
        });

        // Actualizar contadores en tiempo real
        function actualizarContador(id, valor) {
            const elemento = document.getElementById(id);
            if (elemento) {
                let current = parseInt(elemento.textContent) || 0;
                const target = parseInt(valor) || 0;

                if (current !== target) {
                    const incremento = target > current ? 1 : -1;
                    const interval = setInterval(() => {
                        current += incremento;
                        elemento.textContent = current;

                        if (current === target) {
                            clearInterval(interval);
                        }
                    }, 50);
                }
            }
        }

        // CORRECCIÓN: Esta es la parte arreglada (líneas 1005-1010 originales)
        window.addEventListener('load', function () {
            // Primero verificar que la función exista
            if (typeof actualizarContador !== 'function') {
                console.warn('La función actualizarContador no está definida');
                return;
            }

            // Obtener valores de los elementos HTML ya renderizados
            const totalElement = document.getElementById('totalDocumentos');
            const vigentesElement = document.getElementById('documentosVigentes');
            const porVencerElement = document.getElementById('documentosPorVencer');
            const vencidosElement = document.getElementById('documentosVencidos');

            if (totalElement && vigentesElement && porVencerElement && vencidosElement) {
                // Resetear contadores a 0 para animación
                const totalValue = parseInt(totalElement.textContent) || 0;
                const vigentesValue = parseInt(vigentesElement.textContent) || 0;
                const porVencerValue = parseInt(porVencerElement.textContent) || 0;
                const vencidosValue = parseInt(vencidosElement.textContent) || 0;

                // Animar contadores desde 0
                actualizarContador('totalDocumentos', totalValue);
                actualizarContador('documentosVigentes', vigentesValue);
                actualizarContador('documentosPorVencer', porVencerValue);
                actualizarContador('documentosVencidos', vencidosValue);
            }
        });

        // Arrastrar y soltar archivos
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('archivo_documento');

        if (uploadArea) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#0d6efd';
                uploadArea.style.backgroundColor = '#e9f7fe';
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#dee2e6';
                uploadArea.style.backgroundColor = '#f8f9fa';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#dee2e6';
                uploadArea.style.backgroundColor = '#f8f9fa';

                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    previewFile(fileInput);
                }
            });
        }
    </script>
</body>

</html>